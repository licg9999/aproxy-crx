define(function(require,a,b){require("$"),require("_");var c=require("object"),d=require("overlay"),e=require("nw"),f=require("validator"),g=c.create({_tmpl:_.template('<div class="pure-g pair" data-json=<%=json%>>    <div class="pure-u-9-24 from">        <input class="group" type="text" placeholder="\u7ec4\u540d" value="<%=fromGroup%>" disabled/>        <span>/</span>        <input class="project" type="text" placeholder="\u9879\u76ee\u540d" value="<%=fromProject%>" disabled/>        <div class="tip"></div>    </div>    <div class="pure-u-10-24 to">        <input type="text" placeholder="\u76ee\u5f55Path" value="<%=to%>" disabled/>    </div>    <div class="pure-u-5-24 action">        <a href="#" class="pure-button edit" title="\u7f16\u8f91" draggable="false"><i class="fa fa-pencil"></i></a>        <a href="#" class="pure-button save" title="\u4fdd\u5b58" draggable="false" hidden><i class="fa fa-floppy-o"></i></a>        <a href="#" class="pure-button disa" title="\u7981\u7528" draggable="false"><i class="fa fa-stop"></i></a>        <a href="#" class="pure-button enab" title="\u542f\u7528" draggable="false" hidden><i class="fa fa-play"></i></a>        <a href="#" class="pure-button remo" title="\u5220\u9664" draggable="false"><i class="fa fa-trash-o"></i></a>        <a href="#" class="move" title="<%=index%>. <%=name%>" draggable="false"><i class="fa fa-bars"></i></a>    </div></div>'),_$wrap:$(".rules > .wrap"),_$empt:$(".rules > .empty"),addItem:function(a,b){var c=this;a=_.extend({fromGroup:"",fromProject:"",to:"",index:"",name:""},c.parseRuleFrom(a)),b&&(a.index="0"),a.json=JSON.stringify(a);var d=$(c._tmpl(a)).prependTo(c._$wrap);return b&&(d.find(".disa").addClass("add"),d.find(".save").addClass("add"),d.find(".remo").addClass("add"),d.prop("draggable",!1)),d.delegate(".disa.add","click",function(a){a.stopImmediatePropagation()}),d.delegate(".disa","click",function(a){c.disableItem(d)}),d.delegate(".enab","click",function(a){c.enableItem(d)}),d.delegate(".edit","click",function(a){c.editItem(d)}),d.delegate(".save.add","click",function(a){a.stopImmediatePropagation(),c.insertItem(d,function(a){a||(d.find(".add").removeClass("add"),c.setDraggable(d,!0),c.setDroppable(d,!0))})}),d.delegate(".save","click",function(a){c.saveItem(d)}),d.delegate(".remo.add","click",function(a){a.stopImmediatePropagation(),c._removeItem(d)}),d.delegate(".remo","click",function(a){c.removeItem(d)}),d.on("dragstart",function(a){a.originalEvent.dataTransfer.effectAllowed="all",a.originalEvent.dataTransfer.setData("text/plain",d.data("json").index)}),b||(c.setDraggable(d,!0),c.setDroppable(d,!0)),d.on("drop",function(a){var b=c._$wrap.children(".pair").eq(+$.parseJSON(a.originalEvent.dataTransfer.getData("text/plain")));c.adjustItemPos(b,d)}),d},_onDragover:function(a){a.preventDefault()},setDroppable:function(a,b){var c=this;b?a.on("dragover",c._onDragover):a.off("dragover",c._onDragover)},setDraggable:function(a,b){a.prop("draggable",!0)},_adjustPriority:function(a,b,c){var d=this;a!==b?e.json({url:"/rule/priorityAdjust",data:{sindex:a,tindex:b}},function(e,f){if(e||!f.success)c(e||f);else{var g,h,i=d._$wrap.children(".pair");if(b>a){for(g=a+1;b>=g;g++)h=i.eq(g).data("json"),h.index=h.index-1,i.eq(g).data("json",h),d._syncMoveIndex(i.eq(g));h=i.eq(a).data("json"),h.index=b,i.eq(a).data("json",h),d._syncMoveIndex(i.eq(a)),i.eq(a).insertAfter(i.eq(b))}else{for(g=a-1;g>=b;g--)h=i.eq(g).data("json"),h.index=h.index+1,i.eq(g).data("json",h),d._syncMoveIndex(i.eq(g));h=i.eq(a).data("json"),h.index=b,i.eq(a).data("json",h),d._syncMoveIndex(i.eq(a)),i.eq(a).insertBefore(i.eq(b))}c(null)}}):c(null)},adjustItemPos:function(a,b){var c=this;c._adjustPriority(a.data("json").index,b.data("json").index,function(a){a&&d.alert({tip:"\u66f4\u65b0\u4f18\u5148\u7ea7\u5931\u8d25"})})},_addValue:function(a,b,c,d,f){var g=this,h=a.data("json");h.fromGroup=b,h.fromProject=c,h.to=d,g.buildRuleFrom(h),e.json({url:"/rule/add",data:{name:h.name,from:h.from,to:h.to}},function(b,c){b||!c.success?f(b||c):(g.parseRuleFrom(h),a.data("json",h),f(null))})},_syncMoveIndex:function(a){var b=a.data("json");a.find(".move").attr("title",b.index+". "+b.name)},validateItemFields:function(a,b,c){var d=a.val(),e=b.val(),g=c.val();return f.nonEmp(d,"\u7ec4\u540d\u4e0d\u80fd\u4e3a\u7a7a")&&f.maxLen(d,"\u7ec4\u540d\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc732\u5b57",32)&&f.format(d,"\u7ec4\u540d\u4e0d\u80fd\u4ee5\u659c\u6760\u5f00\u59cb\u6216\u7ed3\u675f",/^([^\/].*[^\/]|[^\/])$/)&&f.nonEmp(e,"\u9879\u76ee\u540d\u4e0d\u80fd\u4e3a\u7a7a")&&f.maxLen(e,"\u9879\u76ee\u540d\u4e0d\u80fd\u8d85\u8fc764\u5b57",64)&&f.format(e,"\u9879\u76ee\u540d\u4e0d\u80fd\u4ee5\u659c\u6760\u5f00\u59cb\u6216\u7ed3\u675f",/^([^\/].*[^\/]|[^\/])$/)&&f.nonEmp(g,"\u76ee\u5f55Path\u4e0d\u80fd\u4e3a\u7a7a")&&f.maxLen(g,"\u76ee\u5f55Path\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc7512\u5b57",512)&&f.format(g,"\u76ee\u5f55Path\u4e0d\u80fd\u4e3a\u76f8\u5bf9\u8def\u5f84",/^(\w:)?\//)?(f.format(g,"",/\/$/)||(g+="/",c.val(g)),!0):!1},insertItem:function(a,b){var c=this,e=a.find(".from > .group"),f=a.find(".from > .project"),g=a.find(".to > input");c.validateItemFields(e,f,g)&&c._addValue(a,e.val(),f.val(),g.val(),function(e){e?d.alert({tip:"\u6dfb\u52a0\u89c4\u5219\u5931\u8d25"}):(a.nextAll().filter(function(){return 0===$(this).find(".add").length}).each(function(){var a=$(this),b=a.data("json");b.index=b.index+1,a.data("json",b),c._syncMoveIndex(a)}),c._saveItem(a)),b(e)})},_setDisabled:function(a,b,c){var d=a.data("json");d.disabled!==b?(d.disabled=b,e.json({url:"/rule/set",data:{index:d.index,disabled:d.disabled}},function(b,e){b||!e.success?c(b||e):(a.data("json",d),c(null))})):c(null)},disableItem:function(a){var b=this;b._setDisabled(a,!0,function(b){b?d.alert({tip:"\u7981\u7528\u89c4\u5219\u5931\u8d25"}):(a.addClass("disabled"),a.find(".disa").attr("hidden",""),a.find(".enab").removeAttr("hidden"))})},enableItem:function(a){var b=this;b._setDisabled(a,!1,function(b){b?d.alert({tip:"\u542f\u7528\u89c4\u5219\u5931\u8d25"}):(a.removeClass("disabled"),a.find(".disa").removeAttr("hidden"),a.find(".enab").attr("hidden",""))})},editItem:function(a){a.find(".edit").attr("hidden",""),a.find(".save").removeAttr("hidden"),a.find(".from > input").removeAttr("disabled").first().focus(),a.find(".to > input").removeAttr("disabled")},_setMatch:function(a,b,c,d,f){var g=this,h=a.data("json");h.fromGroup=b,h.fromProject=c,h.to=d,g.buildRuleFrom(h),e.json({url:"/rule/set",data:{index:h.index,from:h.from,to:h.to}},function(b,c){b||!c.success?f(b||c):(a.data("json",h),f(null))})},_saveItem:function(a){a.find(".edit").removeAttr("hidden"),a.find(".save").attr("hidden",""),a.find(".from > input").attr("disabled",""),a.find(".to > input").attr("disabled","")},saveItem:function(a){var b=this,c=a.find(".from > .group"),e=a.find(".from > .project"),f=a.find(".to > input");b.validateItemFields(c,e,f)&&b._setMatch(a,c.val(),e.val(),f.val(),function(c){c?d.alert({tip:"\u4fdd\u5b58\u89c4\u5219\u5931\u8d25"}):b._saveItem(a)})},_removeValue:function(a,b){var c=a.data("json");e.json({url:"/rule/remove",data:{index:c.index}},function(a,c){b(a||!c.success?a||c:null)})},_removeItem:function(a){var b=this;a.remove(),b.checkEmpty()},removeItem:function(a){var b=this;b._removeValue(a,function(c){c?d.alert({tip:"\u5220\u9664\u89c4\u5219\u5931\u8d25"}):(a.nextAll().filter(function(){return 0===$(this).find(".add").length}).each(function(){var a=$(this),b=a.data("json");b.index=b.index-1,a.data("json",b),a.find(".move").attr("title",b.index+". "+b.name)}),b._removeItem(a))})},reloadItems:function(a){var b=this;b.cleanItems(),e.json({url:"/rule/load"},function(c,e){if(c||!e.success)d.alert({tip:"\u83b7\u53d6\u89c4\u5219\u5931\u8d25"}),a(c||e);else{var f,g;for(f=e.rules.length-1;f>=0;f--){g=e.rules[f],_.extend(g,{index:f});var h=b.addItem(g);g.disabled&&b.disableItem(h)}a(null)}})},cleanItems:function(){var a=this;a._$wrap.children(".pair").remove()},parseRuleFrom:function(a){if(a.from){var b=a.from.split("/");a.fromGroup=b[1],a.fromProject=b[2],delete a.from}return a},buildRuleFrom:function(a){return a.fromGroup&&a.fromProject&&(a.from="/"+a.fromGroup+"/"+a.fromProject+"/((\\d+\\.){2}\\d+)/",delete a.fromGroup,delete a.fromProject),a},checkEmpty:function(){var a=this;a._$wrap.children(".pair").length>0?a._$empt.attr("hidden",""):a._$empt.removeAttr("hidden")}});b.exports=g});