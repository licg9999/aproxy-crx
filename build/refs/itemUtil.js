define(function(a,b,c){a("$"),a("_");var d=a("object"),e=a("overlay"),f=a("nw"),g=d.create({_tmpl:_.template('<div class="pure-g pair" data-json=<%=json%>>    <div class="pure-u-9-24 from">        <input class="group" type="text" placeholder="组名" value="<%=fromGroup%>" disabled/>        <span>/</span>        <input class="project" type="text" placeholder="项目名" value="<%=fromProject%>" disabled/>        <div class="tip"></div>    </div>    <div class="pure-u-10-24 to">        <input type="text" placeholder="目录Path" value="<%=to%>" disabled/>    </div>    <div class="pure-u-5-24 action">        <a href="#" class="pure-button edit" title="编辑"><i class="fa fa-pencil"></i></a>        <a href="#" class="pure-button save" title="保存" hidden><i class="fa fa-floppy-o"></i></a>        <a href="#" class="pure-button disa" title="禁用"><i class="fa fa-stop"></i></a>        <a href="#" class="pure-button enab" title="启用" hidden><i class="fa fa-play"></i></a>        <a href="#" class="pure-button remo" title="删除"><i class="fa fa-trash-o"></i></a>        <a href="#" class="move" title="<%=index%>. <%=name%>"><i class="fa fa-bars"></i></a>    </div></div>'),_$wrap:$(".rules > .wrap"),_$empt:$(".rules > .empty"),addItem:function(a){var b=this;a=_.extend({fromGroup:"",fromProject:"",to:"",index:"",name:""},b.parseRuleFrom(a)),a.json=JSON.stringify(a);var c=$(b._tmpl(a)).appendTo(b._$wrap);return c.delegate(".disa","click",function(a){b.disableItem(c)}),c.delegate(".enab","click",function(a){b.enableItem(c)}),c.delegate(".edit","click",function(a){b.editItem(c)}),c.delegate(".save","click",function(a){b.saveItem(c)}),c.delegate(".remo","click",function(a){b.removeItem(c)}),c},_setDisabled:function(a,b,c){var d=a.data("json");d.disabled!==b?(d.disabled=b,a.data("json",d),f.json({url:"/rule/set",data:{index:d.index,disabled:d.disabled}},function(a,b){c(a||!b.success?a||b:null)})):c(null)},disableItem:function(a){var b=this;b._setDisabled(a,!0,function(b){b?e.alert({tip:"禁用规则失败"}):(a.addClass("disabled"),a.find(".disa").attr("hidden",""),a.find(".enab").removeAttr("hidden"))})},enableItem:function(a){var b=this;b._setDisabled(a,!1,function(b){b?e.alert({tip:"启用规则失败"}):(a.removeClass("disabled"),a.find(".disa").removeAttr("hidden"),a.find(".enab").attr("hidden",""))})},editItem:function(a){a.find(".edit").attr("hidden",""),a.find(".save").removeAttr("hidden"),a.find(".from > input").removeAttr("disabled").first().focus(),a.find(".to > input").removeAttr("disabled")},_setMatch:function(a,b,c,d,e){var g=this,h=a.data("json");h.fromGroup=b,h.fromProject=c,h.to=d,a.data(h),g.buildRuleFrom(h),f.json({url:"/rule/set",data:{index:h.index,from:h.from,to:h.to}},function(a,b){e(a||!b.success?a||b:null)})},saveItem:function(a){var b=this,c=a.find(".from > .group"),d=a.find(".from > .project"),f=a.find(".to > input");b._setMatch(a,c.val(),d.val(),f.val(),function(b){b?e.alert({tip:"保存规则失败"}):(a.find(".edit").removeAttr("hidden"),a.find(".save").attr("hidden",""),a.find(".from > input").attr("disabled",""),a.find(".to > input").attr("disabled",""))})},_removeValue:function(a,b){var c=a.data("json");f.json({url:"/rule/remove",data:{index:c.index}},function(a,c){b(a||!c.success?a||c:null)})},removeItem:function(a){var b=this;b._removeValue(a,function(c){c?e.alert({tip:"删除规则失败"}):(a.nextAll().each(function(){var a=$(this),b=a.data("json");b.index--,a.data(b),a.find(".move").attr("title",b.index+". "+b.name)}),a.remove(),b.checkEmpty())})},reloadItems:function(a){var b=this;f.json({url:"/rule/load"},function(c,d){!c&&d.success?(_.each(d.rules,function(a,c){_.extend(a,{index:c});var d=b.addItem(a);a.disabled&&b.disableItem(d)}),a(null)):e.alert({tip:"获取规则失败"})})},parseRuleFrom:function(a){var b=a.from.split("/");return a.fromGroup=b[1],a.fromProject=b[2],delete a.from,a},buildRuleFrom:function(a){return a.from="/"+a.fromGroup+"/"+a.fromProject+"/((\\d+\\.){2}\\d+)/",delete a.fromGroup,delete a.fromProject,a},checkEmpty:function(){var a=this;a._$wrap.children(".pair").length>0?a._$empt.attr("hidden",""):a._$empt.removeAttr("hidden")}});c.exports=g});